#!/bin/sh -x
# Part of spindle http://asbradbury.org/projects/spindle
#
# See LICENSE file for copyright and license details

set -ex

. ./common

WORKDIR=work
OUTDIR=out
CURIMG=stage4.$IMGFORMAT


setup_stratux_bootconfig() {
	dotask attach_image_to_nbd $CURIMG $NBD_DEV
	mkdir boot
	dotask sudo mount $BOOT_DEV boot
	#usb power
	echo "max_usb_current=1" >>boot/config.txt
	#i2c
	echo "dtparam=i2c1=on" >>boot/config.txt
}

setup_stratux() {
#HERE

echo "**** STRATUX SETUP *****"

  ssh_in_to_qemu chroot /mnt sh -l -ex - <<\EOF
#general
apt-get install -y screen
#wifi
apt-get install -y hostapd isc-dhcp-server
#troubleshooting
apt-get install -y tcpdump
#wifi startup
update-rc.d hostapd enable
update-rc.d isc-dhcp-server enable
#read-only stuff
apt-get install -y unionfs-fuse
EOF

curl -L -o /tmp/hostapd-edimax http://dl.dropbox.com/u/1663660/hostapd/hostapd?dl=1
scp_in_to_qemu /tmp/hostapd-edimax /tmp/hostapd.in
scp_in_to_qemu ../../interfaces /tmp/interfaces.in
scp_in_to_qemu ../../dhcpd.conf /tmp/dhcpd.conf.in
scp_in_to_qemu ../../hostapd.conf /tmp/hostapd.conf.in
scp_in_to_qemu ../../isc-dhcp-server /tmp/isc-dhcp-server.in
scp_in_to_qemu ../../sshd_config /tmp/sshd_config.in
scp_in_to_qemu ../../mount_unionfs /tmp/mount_unionfs.in

 ssh_in_to_qemu chroot /mnt sh -l -ex - <<\EOF
mv -f /tmp/hostapd.in /usr/sbin/hostapd
chown root.root /usr/sbin/hostapd
chmod 755 /usr/sbin/hostapd

mv -f /tmp/interfaces.in /etc/network/interfaces
mv -f /tmp/dhcpd.conf.in /etc/dhcp/dhcpd.conf
mv -f /tmp/hostapd.conf.in /etc/hostapd/hostapd.conf
mv -f /tmp/isc-dhcp-server.in /etc/default/isc-dhcp-server
mv -f /tmp/sshd_config.in /etc/ssh/sshd_config
mv -f /tmp/mount_unionfs.in /usr/local/bin/mount_unionfs
rm -f /usr/share/dbus-1/system-services/fi.epitest.hostap.WPASupplicant.service

chmod 755 /usr/local/bin/mount_unionfs

sed -r 's/(\/dev\/mmcblk[[:alnum:]]+([[:space:]]+[[:graph:]]+){2}[[:space:]]+)([[:graph:]]+)([[:space:]]+.*)/\1ro,\3\4/g' -i /etc/fstab

echo "
mount_unionfs   /etc            fuse    defaults          0       0
mount_unionfs   /var            fuse    defaults          0       0
none            /tmp            tmpfs   defaults          0       0" >> /etc/fstab

echo "DAEMON_CONF=\"/etc/hostapd/hostapd.conf\"" >/etc/default/hostapd

echo blacklist dvb_usb_rtl28xxu >>/etc/modprobe.d/rtl-sdr-blacklist.conf
echo blacklist e4000 >>/etc/modprobe.d/rtl-sdr-blacklist.conf
echo blacklist rtl2832 >>/etc/modprobe.d/rtl-sdr-blacklist.conf


echo "# prevent power down of wireless when idle" >>/etc/modprobe.d/8192cu.conf
echo "options 8192cu rtw_power_mgnt=0 rtw_enusbss=0" >>/etc/modprobe.d/8192cu.conf

EOF

echo "*** STRATUX COMPILE/PACKAGE INSTALL ***"
echo " - RTL-SDR tools"

  ssh_in_to_qemu chroot /mnt sh -l -ex - <<\EOF
apt-get install -y git cmake libusb-1.0-0.dev build-essential


cd /root
rm -rf rtl-sdr
git clone git://git.osmocom.org/rtl-sdr.git
cd rtl-sdr
mkdir build
cd build
cmake ../
make
make install
ldconfig
EOF

echo " - dump1090"
  ssh_in_to_qemu chroot /mnt sh -l -ex - <<\EOF
cd /root
rm -rf dump1090
git clone https://github.com/antirez/dump1090
cd dump1090
make
cp dump1090 /usr/bin/
EOF

echo " - Stratux"

scp_in_to_qemu ../../../gen_gdl90 /tmp/gen_gdl90

  ssh_in_to_qemu chroot /mnt sh -l -ex - <<\EOF
cd /root

rm -rf stratux
git clone https://github.com/cyoung/stratux
cd stratux
mkdir -p /var/www
cp -r web/* /var/www/
cd dump978
make
cp dump978 /usr/bin/
cd ..

mv /tmp/gen_gdl90 /usr/bin/gen_gdl90
chmod +x /usr/bin/gen_gdl90
cp start_uat.sh /usr/bin/start_uat
cp init.d-stratux /etc/init.d/stratux
cp start_stratux.sh /usr/sbin/stratux
chmod 755 /usr/bin/start_uat
chmod 755 /usr/sbin/stratux
chmod 755 /etc/init.d/stratux
ln -s /etc/init.d/stratux /etc/rc2.d/S01stratux
ln -s /etc/init.d/stratux /etc/rc6.d/K01stratux

update-rc.d stratux enable


#i2c
echo "i2c-bcm2708" >>/etc/modules
echo "i2c-dev" >>/etc/modules

cp -al /etc /etc_org
cp -a /var /var_org
mkdir -p /etc_rw
mkdir -p /var /var_rw

EOF

echo "**** END STRATUX SETUP *****"
#DONE HERE
}




cd $WORKDIR
dotask branch_image ../$OUTDIR/stage3.$IMGFORMAT $CURIMG


dotask run_qemu $CURIMG
dotask mount_apt_cache
dotask disable_starting_services


dotask setup_stratux


dotask save_space_using_hardlink
dotask allow_starting_services
dotask update_issue
dotask fingerprint_debian
dotask shutdown_qemu


dotask setup_stratux_bootconfig
universal_cleanup


dotask finish_image
